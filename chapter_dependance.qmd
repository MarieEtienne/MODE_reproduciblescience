---
title: "Chapter : statistical tests with dependent data"
bibliography: references.bib
execute: 
  freeze: auto
output: 
  html_document:
   toc: true
   toc_float: true
editor: 
  markdown: 
    wrap: sentence
---



This chapter is a simple example using R

You can import R package using the code


```{r}
library(tidyverse)
```

# Introduction

## What is autocorrelation ?
Statistical analyses, including many regression methods, often assume that observations are independent of each other. Most of the time, it seems natural to analyse two different datas, X and Y, assuming their independence. But there may still be a dependency intrinsic to each of them: this is known as autocorrelation. Autocorrelation indicates that the independence assumption is not satisfied, which can lead to biased parameter estimates, incorrect confidence intervals and a loss of statistical power. <br />

In statistics, autocorrelation is a measure of the linear dependence between the values of one variable itself, at different times or locations. Checking for autocorrelation in a variable means analyzing the relationship between an observation and other previous observations in the series. In other words, this means analyzing the possible link between what is measured at time 1 and what is measured at time 2, to see if the data at time 2 can be predicted with what we know about the data at time 1, if they are close in space or time. <br />

Correlation between two observations is often expressed as a correlation coefficient, such as Pearson's correlation coefficient. Values are correlated with an offset function in time or space, giving an autocorrelation coefficient which may be:<br />
* positive: indicating that the observations tend to be similar, <br />
* negative: indicating that the observations tend to be opposite to each other.
<br />

## What types of autocorrelation ?
Autocorrelation is commonly used to analyze data for which the order or location of observations has an important significance, such as:<br />
* time series: data taken at the same location at several points in time, <br />
* spatial data: data taken at a given point in time at several locations in the same geographical area, and therefore close in space. 

### Time series
A typical example of autocorrelation in a time series is a seasonal autocorrelation, where values are observed at a same time each year (seasons), and are therefore correlated with each other. <br />

Temporal autocorrelation shows spatial similarities that depend on the scale used.<br />
![**(from P. LeGouar)**](Intro_dependance.jpg)
<br />

Temporal autocorrelation in ecology is important for understanding the processes of reproduction, migration, population dispersal and species responses to seasonal environmental changes. 

#### Example of temporal autocorrelation
An example of temporal autocorrelation in ecology concerns populations of animal or plant species, particularly when studying seasonal variations. Let's imagine a study of annual fluctuations in the population of migratory birds in a given region. Temporal autocorrelation means that the number of birds observed at a given time of the year is correlated with the number of birds observed at the same time of the previous year. <br />

Suppose the data show positive temporal autocorrelation for a migratory bird species. This would mean that if, for example, in April of the current year, a large number of these birds are observed, it is highly likely that in April of the previous year, a large number of these same birds were also observed. This temporal dependence may be due to seasonal bird migrations, the availability of food resources or other cyclical environmental factors.

### Spatial dependence
Spatial autocorrelation refers to the correlation between observations in close spatial locations. <br />
It shows temporal similarities that depend on the scale used. Spatial autocorrelation is important for understanding patterns of species distribution, population dispersal, biotic interactions and ecological processes at different spatial scales. <br />

Spatial autocorrelation can be due to various factors, such as :

* Microclimate effects: local characteristics of terrain, vegetation or topography can influence temperature on a small scale,

* Dispersion phenomena: the propagation of heat, wind, humidity or other environmental factors can cause spatial autocorrelation,

* Biotic interactions: interactions between plant, animal and micro-organism species in an ecosystem can also influence the spatial distribution of variables such as temperature.

#### Example of spatial dependence
An example of spatial autocorrelation is the observation of temperature distribution in a large forest. Let's imagine a large, dense forest with many weather stations measuring temperatures at different locations. Spatial autocorrelation would manifest itself in the fact that temperatures recorded at nearby locations in the forest are correlated, i.e. they tend to be similar. <br />

Suppose the data show positive spatial autocorrelation. This would mean that, if you have two weather stations located close to each other (say, a few meters apart), the temperatures measured at these two stations at any given time are highly positively correlated. In other words, when one of the stations records a high temperature, the other station will also tend to record a high temperature, and vice versa. <br />

## Why is this important?
Autocorrelation is an essential concept in statistics, as it can have a significant impact on data analysis. In the presence of pseudoreplications, meaning that several different values are thought to be taken when in fact they are dependent on each other, it may appear that one variable has a significant effect on another, when in reality this effect is biased due to the temporal or spatial dependence of the data. It can therefore have a significant impact on statistical analysis, and often requires adjustments to ensure that results are reliable and unbiased. <br />

Autocorrelation checking is an essential process in statistics to guarantee the accuracy, reliability and validity of analyses. It enables appropriate statistical methods to be applied, biases to be corrected and informed modeling and forecasting decisions to be made. It is also essential for understanding patterns of variation in biological data.

<br />


# Time dependence

For example a basic summary of a dataset is given by
and then describe the purpose of your chapter as well as executing R command.



```{r}
df <- read.table("https://gist.githubusercontent.com/slopp/ce3b90b9168f2f921784de84fa445651/raw/4ecf3041f0ed4913e7c230758733948bc561f434/penguins.csv", sep = "," , header = TRUE)
```

and produce a graph

```{r}
df %>% ggplot() +
	aes(x=species, y = body_mass_g) +
	geom_boxplot()  
```


# Space dependence

# II - Spatial series

Spatial relationships are multidirectional and multilateral.
They are distinct, in this sense, from temporal relationships, which allow only sequential relationships along the past-present-future axis.

#2.1) Defining neighbours 
#2.1.1) Characteristics of the relationships between spatial objects 
Consider a surface ℜ. This surface can be divided into n mutually exclusive zones.
Two adjacent zones are separated by a common boundary.

    Mathematical definition of spatial relationships : Spatial relationships B are a subset of the Cartesian product R² × R² = [(i, j) : i ∈ R² , j ∈ R²] of couples (i, j) of spatial objects, i.e. all couples (i, j) such that i and j are both spatial objects identified by their geographical coordinates, and such that (i, j) is different from (j,i). A spatial object cannot be linked to itself: (i,i) \* B. Moreover, if (i, j) ⊆ B and (j,i) ⊆ B for all couples of spatial objects, the spatial relationships are said to be symmetrical (Tiefelsdorf 1998).

Figure 2 illustrates the codifying process of spatial relationships.
This approach makes it possible to systematically transcribe the complexity of geographic space into a final set of data analysable by a computer.

## 3 - Saptial modeling

Once the structure of the spatial correlation has be estimated, it can then be included in the model.

Depending on the structure of the autocorrelation and especially if the process is or is not stationary,and of the structure of the residuals, the analysis required will be different and more or less difficult.

For the analysis under R, it will be important to import the package **spatialreg**, **spdep** as well as **gwrr**

```{r}
library(spatialreg)
library(spdep)
library(gwrr)
```

### 3.1.Stationary process

For the models described here, it is required for the processes to be stationary, meaning that the process is constant across regions. Another assumption is that the spatial autocorrelation is isotropic. This means that the cause of the autocorrelation act the same way in every direction. Anisotropy may be caused for example by environmental factors like the wind or water currents.

All the models showed here will be based on the general linear model modified to take the spatial autocorrelation into account :

**Y = X**$\beta$ + $\epsilon$

#### 3.1.1. Spatially lagged X model

##### Theory

This analysis best perform on local analysis. If the scale is to big, it may be wiser to use another analysis as this one will lack precision.

The idea behind this analysis is that the state of a neighbor region will affect our region.

This model estimate how well the response variable at one site reflect the response values at its surrounding sites.

An extra parameter : WX$\theta$, called the autocovariate is added to the general linear model's formula. It is a distance-weighted function of the neighboring response value.

**Y = X**$\beta$ + **WX**$\theta$ + $\epsilon$

The argument WX$\theta$ is the average of the neighboring Xs.

##### Application in R

*(For the purpose of the example, we will assume that the analysis is the right one even though other would be more fitted)*

As this analysis is quite simple the average value of the neighboring regions can be calculated by hand and then added to the general linear formula.

However, there are commands in R in the package sdpep that allows to do the same analysis ans to go a little further, as well as giving the R-squared value and the p value.

Our exemple here will be the study of plants and bird richness in Ile & Vilaine.

*(The dataset "div35" set can be found in the doc called "Spatial autocorrelation\_ modelisation")*

*(To see how to create weighted matrix, see the previous parts)*

```{r}
div35=read.table("MODE_reproduciblescience\Spatial autocorrelation_ modelisation\div35.txt", header=T, dec=",")

xy=div35[,3:4] #Extract the coordinates x and y of each points
plot(div35[,3:4])
#For a rook connection
div.knear4<-knearneigh(as.matrix(xy),4) #extract the neighbour points
knn2nb(div.knear4) # convert the object of type knn into a type nb # transformation to get as many lists than points/observation
plot(knn2nb(div.knear4), xy, add=TRUE)

#For a Queen conection
div.knear8<-knearneigh(as.matrix(xy),8)
knn2nb(div.knear8)
plot(knn2nb(div.knear8), xy, add=TRUE)

#Spatial weighted matrix
pond4.stan<- nb2listw(knn2nb(div.knear4), style="W", zero.policy=TRUE)
pond8.stan<- nb2listw(knn2nb(div.knear8), style="W", zero.policy=TRUE)

#The argument "style = "w"" allows to determine the weight given to each link. 
# "W" for standardized = 1/nb of connections
#if you want to give the same weight to each link, then use the argument "B" instead of "w".

```

*(to be able to use the weighted matrix in the analysis, the items must be a class "listw", hence the argument "nb2listw")*

The function used for spatially weighted matrix is "lmslx". In the argument :

-   First the equation tested in shape of : Y \~ X1+X2+X3 ...

-   the data set (here div35)

-   The weighted matrix ( here pond8.stan)

```{r}
lmsSLX=spatialreg::lmSLX(rich_ois~rich_pp,data=div35,pond8.stan)
summary(lmsSLX)
```

Here, 2 coefficients are given as well as their p-value. The first one (rich_pp) correspond to the argument X$\beta$ of our original function. The second one (lag.rich_pp) correspond to WX$\theta$.

*Here there is only one X, and therefore only 2 coefficients, but with a bigger model to test, the coefficients corresponding to the X will be named just like the original Xs, and the coefficients for the autocorrelation will be named "lag.X".*

As always, we only keep the coefficients that have a significant p-value. Here they all do. Our final model here would be :

$Bird\:Richness = -7.40 + 0.47X + 1.19WY + \epsilon$

An interpretation of those results here is that the more plants there is in a place, the more bird will be present as well. As for the lag value, we can expect that the more plants there will in the neighboring regions, the more birds there will in our region.

*This model works at small scale only*

The first estimate, that regards the response variable is called the **direct effect**, wherease the factor impacting the autocorrelation is called the **indirect factor**. However we can have an idea of the general effect on the whole region by combining the two effects int the **total effect**.

```{r}
impacts(lmsSLX)
summary(impacts(lmsSLX, R=500),zstats=TRUE)
```

The function impact only gives the total effect as the sum of the direct and indirect effect. Putting the function into a summary allows to show standard error, and the p-values. The total effect represent the overall impact of the variable when applied to the whole map.

*Sometimes, non-significant direct and indirect effect may become significant when looking at the total effect*

#### 3.1.2. - Simultaneous autoregressive models (SAR)

To be able to study an autocorrelation at a larger scale, other models must be used.

The SAR model is an autoregressive model.These models take spatial autocorrelation into account by using a neighborhood matrix specifying the relationship between the residuals at each location.

The SAR model allows to study directional processes, which, in ecology, are quite common ( ex : wind dispersal or stream flows). The null hypothesis for the general SAR model is that the Ys are mutually independent.

The autoregressif process can be found in either the residuals of the data or in the response value. Depending on where this process is thought to be,three models are available :

-   The **Error model**
-   The **Lag model**
-   The **Mix model**

A specific diagnostic can be made to chose between either one.

##### 3.1.2.1. Lagrange Multiplier diagnostic

###### Theory

The idea for this test is to statistically check which of the SAR model would best fit to our equation.

The lagrange multiplier diagnostic tests the fit of the model under the null hypothesis and looks for evidence of departures in the direction of interest. In summary, it will examine the residuals of a model and look for specific types of non-randomness.

###### Application in R

The command lm.LMtests() allows to get the lagrange multiplier for a set model.

```{r}
lmO=lm(div35$rich_ois~div35$rich_pp)
lm.LMtests(lmO,pond8.stan, test="all")
```

The arguments are :

-   The dataset (here lm0)

-   The weight matrix (here pond8.stan)

-   test = the type of test that will be made (here, "all" means that the fives tests will be conducted : LMerr, LMlag, RLMerr, RLMlag, SARMA)

The firsts p-values to look at are for the normal tests. The significant one will be the analysis conducted later. If non of them are significant, we look at the robust tests.

##### 3.1.2.2. Lag models

###### Theory

In this model, we assume that the autoregressif process is in the response variable. As this model is general, this means that anything affecting our Y, will also affect its neighbor in some way, affecting us in return. This creates a feedback effect.

It would for exemple be liked a stone thrown in a lake. This creates waves that propagate to the whole lake.

The lag model is used to take into account a autoregressif process only occuring in the response variable. Therefore, the responsable variable argument in the model will include a term for the spatial autocorrelation : **ρW**

The model will take the form of :

**Y =**$\rho$**Wx +X**$\beta$ + $\epsilon$

**ρ** is the autoregression parameter **W** is the spatial weights matrix

###### Application in R

```{r}
lagsarlm(rich_ois~rich_pp, div35, pond8.stan)
```

Using the values obtained here, the final model would be:

$Bird\:Richness = 0.37\:WX +0.53\:X + \epsilon$

##### 3.1.2.3. Error models

###### Theory

When using the error model, we assume that the autoregressif process is only in the residuals.

When dealing with such model, an interpretation may be that some spatially correlated variable are missing in the dataset.

this model takes the form of :

**Y = X**$\beta$ + $\lambda$**WY** + $\epsilon$

The term $\lambda$W represent the spatial structure with $\lambda$ being the spatial autoregression coefiscient. $\gamma$ is the spatially dependant error term.

###### Application in R

```{r}
errorsarlm(rich_ois~rich_pp, data = div35, pond8.stan)
```

Using the values obtained here, the final model would be:

$Bird\:Richness =0.52\:X + 0.33\:WY + \epsilon$

##### 3.1.2.4. Mixed models

###### Theory

If the spatial autocorrelation affect both the response variable and the residuals, the mix model is used. This model include all the parameter added above, and it is the most inclusive model.

It can be noted that this model can also be used in both situation described previously, as the coefficient will cancel themselves out if either one is not present.

**Y =** $\rho$**WX +X**$\beta$ + $\lambda$**WY** + $\epsilon$

###### Application in R

```{r}
lmsarD=spatialreg::sacsarlm(rich_ois~rich_pp,data=div35,pond8.stan)
summary(lmsarD)
```

From here, we can replace in the formula :

$Bird\:Richness = 0.64WX + 0.53X - 0.65$

*For exemple purpose, the lambda was implemented in the model. However it was not necessary here as the associated value was not significant*

Even though three commands are available for each type of SAR model, it is best to only use the mixed model function sacsarlm, as the other ones don't provide p-values, and this one provides more information than the others.

![](Spatial autocorrelation_ modelisation\SAR_function_summary.png)

*(If the image doesn't load, it is available in the Spatial autocorrelation\_ modelisation doc)*

### 3.2. - Non stationary process

**Graphically weighted models (GWM)**

###### Theory

In ecology, a lot of processes are non stationary. This model is one of the few that allow to deal with non-stationarity. It is a local modeling.


The model is fitted to be locally linear : 

$$Y_i = \beta_{0i}\:+\:\sum_k\beta_{ki}x_{ki}\:+\epsilon_i$$

The $\beta$ here now correspond to the coefficient at the location i.

It applies a geographical weight to the data used in each model, meaning that the further away a point will be from the regression point, the less weight they will have.
This model require the use of a function called the **Kernel function**. 
It consists in an equation giving the weights $w_ij$ relating the focal point $i$ to each observation $j$. This means it places a "window" over the observation.

To define the "window" or **bandwidth**, a local regression is made with a set bandwidth and then used to predict the values of the dependant variables. The residuals obtained are compared to other residuals from other regressions made with different bandwidth and the smallest local residuals are kept. 

Once the bandwidth is defined, the regression is made for each points and the result can be mapped.

###### Application in R

The function gwr.est will define the optimal bandwidth.

```{r}
lmgwrD=gwr.est(rich_ois~rich_pp,data=div35,locs=xy)
summary(lmgwrD)

#The value for each parameters are obtained by directly fetching the parameters from the list :
lmgwrD$phi #gives the bandwidth
lmgwrD$RMSPE #gives the root-square of the bandwidth
```

**Phi**: kernel bandwidth 

**RMSPE**: root square of error of the prediction based on bandwidth estimated

**Beta**: matrix with the coefficients for each point (intercept line \[1,\] and regression coefficient line \[2,\]) 

**Yhat**: model estimate 

**RMSE**: root square of error estimation 

**Rsquare**: model fitting

```{r}
plot(xy)
s.value(xy,lmgwrD$beta[2,],add.plot=T)

```

The result can finally be plotted for each point.

# Summary

# References

F. Dormann, Carsten, Jana M. McPherson, Miguel B. Araújo, Roger Bivand, Janine Bolliger, Gudrun Carl, Richard G. Davies, et al. « Methods to Account for Spatial Autocorrelation in the Analysis of Species Distributional Data: A Review ». Ecography 30, nᵒ 5 (2007): 609‑28. https://doi.org/10.1111/j.2007.0906-7590.05171.x.

Smith, P. A. (1994). Autocorrelation in Logistic Regression Modelling of Species' Distributions. Global Ecology and Biogeography Letters, 4(2), 47--. doi:10.2307/2997753

Getis, Arthur. «Spatial Autocorrelation». In Handbook of Applied Spatial Analysis: Software Tools, Methods and Applications, édité par Manfred M. Fischer et Arthur Getis, 255‑78. Berlin, Heidelberg: Springer, 2010.  https://doi.org/10.1007/978-3-642-03647-7_14.

https://www.youtube.com/watch?v=b3HtV2Mhmvk

Engle, Robert F. « A general approach to lagrange multiplier model diagnostics ». Journal of Econometrics 20, nᵒ 1 (1 octobre 1982): 83‑104. https://doi.org/10.1016/0304-4076(82)90104-X.

Class and powerpoint made by Mrs. Le Gouar Pascaline

GWR informations : https://pro.arcgis.com/en/pro-app/latest/tool-reference/spatial-statistics/how-geographicallyweightedregression-works.htm

Páez, A., et D. C. Wheeler. « Geographically Weighted Regression ». In International Encyclopedia of Human Geography, édité par Rob Kitchin et Nigel Thrift, 407‑14. Oxford: Elsevier, 2009. https://doi.org/10.1016/B978-008044910-4.00447-8.

https://gdsl-ul.github.io/san/09-gwr.html